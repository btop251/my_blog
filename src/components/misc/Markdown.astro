---
// 只加载基础的等宽字体，减少加载时间
import "@fontsource-variable/jetbrains-mono";
import DOMPurify from 'dompurify';

interface Props {
	class: string;
}

const className = Astro.props.class;

// 由于Astro的slot内容不能直接在服务端访问，我们需要在客户端进行sanitize
// 服务端渲染时使用原始内容，客户端进行二次保护
---

<div 
    id="markdown-content"
    data-pagefind-body 
    class={`prose dark:prose-invert prose-base !max-w-none custom-md ${className}`}
>
    <slot/>
</div>

<script>
// 在客户端对Markdown内容进行XSS防护
document.addEventListener('DOMContentLoaded', () => {
    const markdownContainer = document.getElementById('markdown-content');
    if (!markdownContainer) return;

    // 创建DOMPurify实例
    const purify = DOMPurify(window);
    
    // 配置DOMPurify（允许代码高亮相关的class，但阻止脚本执行）
    purify.setConfig({
        ALLOWED_ATTR: [
            'class', 'id', 'style', 'src', 'alt', 'href', 'target', 'rel',
            'data-language', 'data-line-numbers', 'data-pagefind-body',
            'data-pagefind-weight', 'data-pagefind-meta'
        ],
        ALLOWED_TAGS: [
            'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'div', 'span', 'br', 'hr',
            'pre', 'code', 'blockquote', 'ul', 'ol', 'li', 'table', 'thead', 'tbody',
            'tr', 'th', 'td', 'a', 'strong', 'em', 'img', 'figure', 'figcaption',
            'del', 'ins', 'sup', 'sub', 'abbr', 'kbd', 'mark', 'small', 'details', 'summary'
        ],
        FORBID_TAGS: ['script', 'style', 'iframe', 'object', 'embed', 'form', 'input', 'button'],
        FORBID_ATTR: ['onclick', 'onload', 'onerror', 'onmouseover', 'style'],
        // 允许data属性用于页面搜索和代码高亮
        ADD_ATTR: ['data-language', 'data-line-numbers', 'data-pagefind-body', 'data-pagefind-weight', 'data-pagefind-meta'],
        // 返回经过清理的DOM而不是字符串
        RETURN_DOM: false,
        RETURN_DOM_FRAGMENT: false,
        RETURN_DOM_IMPORT: false,
        SANITIZE_DOM: true,
        KEEP_CONTENT: true
    });

    // 保存原始HTML
    const originalHTML = markdownContainer.innerHTML;
    
    try {
        // 使用DOMPurify清理内容
        const cleanHTML = purify.sanitize(originalHTML);
        
        // 用清理后的内容替换原始内容
        markdownContainer.innerHTML = cleanHTML;
        
        console.log('Markdown内容已进行XSS防护处理');
    } catch (error) {
        console.error('XSS防护处理失败:', error);
        // 如果清理失败，至少移除明显的危险标签
        markdownContainer.innerHTML = originalHTML
            .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
            .replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi, '')
            .replace(/on\w+="[^"]*"/g, '')
            .replace(/on\w+='[^']*'/g, '')
            .replace(/javascript:/gi, '');
    }

    // 原有的复制按钮功能（保持不变）
    document.addEventListener("click", function (e) {
        const target = e.target;
        if (target && target.classList.contains("copy-btn")) {
            // ... 原有的复制按钮代码保持不变 ...
            const preEle = target.closest("pre");
            const codeEle = preEle?.querySelector("code");
            
            // 精确的代码提取逻辑（原有代码）
            let code = '';
            if (codeEle) {
                const lineElements = codeEle.querySelectorAll('span.line');
                if (lineElements.length > 0) {
                    const lines = [];
                    for (let i = 0; i < lineElements.length; i++) {
                        const lineElement = lineElements[i];
                        const lineText = lineElement.textContent || '';
                        lines.push(lineText);
                    }
                    code = lines.join('\n');
                } else {
                    const codeElements = codeEle.querySelectorAll('.code:not(summary *)');
                    if (codeElements.length > 0) {
                        const lines = [];
                        for (let i = 0; i < codeElements.length; i++) {
                            const el = codeElements[i];
                            const lineText = el.textContent || '';
                            lines.push(lineText);
                        }
                        code = lines.join('\n');
                    } else {
                        code = codeEle.textContent || '';
                    }
                }
            }
            
            // 处理连续空行（原有代码）
            code = code.replace(/\n\n\n+/g, function(match) {
                const newlineCount = match.length;
                const emptyLineCount = newlineCount - 1;
                let resultEmptyLines;
                if (emptyLineCount % 2 === 0) {
                    resultEmptyLines = emptyLineCount / 2;
                } else {
                    resultEmptyLines = Math.floor((emptyLineCount + 1) / 2);
                }
                if (resultEmptyLines < 1) resultEmptyLines = 1;
                return '\n'.repeat(resultEmptyLines + 1);
            });
            
            // 复制到剪贴板（原有代码）
            const copyToClipboard = async (text) => {
                try {
                    await navigator.clipboard.writeText(text);
                } catch (clipboardErr) {
                    console.warn('Clipboard API 失败，尝试备用方案:', clipboardErr);
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    try {
                        const successful = document.execCommand('copy');
                        if (!successful) {
                            throw new Error('execCommand 返回 false');
                        }
                    } catch (execErr) {
                        console.error('execCommand 也失败了:', execErr);
                        throw new Error('所有复制方法都失败了');
                    } finally {
                        document.body.removeChild(textArea);
                    }
                }
            };
            
            copyToClipboard(code).then(() => {
                const timeoutId = target.getAttribute("data-timeout-id");
                if (timeoutId) {
                    clearTimeout(parseInt(timeoutId));
                }

                target.classList.add("success");

                const newTimeoutId = setTimeout(() => {
                    target.classList.remove("success");
                }, 1000);

                target.setAttribute("data-timeout-id", newTimeoutId.toString());
            }).catch(err => {
                console.error('复制失败:', err);
            });
        }
    });
});
</script>